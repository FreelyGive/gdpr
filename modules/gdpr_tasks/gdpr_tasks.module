<?php

/**
 * @file
 * Module file for the GDPR Tasks module.
 */

/**
 * Implements hook_entity_info().
 */
function gdpr_tasks_entity_info() {
  $entities =  array();

  $entities['gdpr_task'] = array(
    'label' => t('Task'),
    'base table' => 'gdpr_task',
    'entity class' => 'GDPRTask',
    'controller class' => 'GDPRTaskController',
    'module' => 'gdpr_tasks',
    'admin ui' => array(
      'path' => 'admin/structure/gdpr-tasks',
      'file' => 'gdpr_tasks.admin.inc',
      'menu wildcard' => '%gdpr_task',
      'controller class' => 'GDPRTaskUIController',
    ),
    'access callback' => 'gdpr_task_access',
    'entity keys' => array(
      'id' => 'id',
      'bundle' => 'type',
      'label' => 'id',
      'language' => 'language',
    ),
    'bundle keys' => array(
      'bundle' => 'type',
    ),
    'bundles' => array(
      'gdpr_remove' => array(
        'label' => 'Removal Request',
        'admin' => array(
          'path' => 'admin/structure/gdpr-tasks/manage/%',
          'real path' => 'admin/structure/gdpr-tasks/manage/gdpr_remove',
          'bundle argument' => 4,
          'access arguments' => array('administer task entities'),
        ),
      ),
      'gdpr_sar' => array(
        'label' => 'SARs Request',
        'admin' => array(
          'path' => 'admin/structure/gdpr-tasks/manage/%',
          'real path' => 'admin/structure/gdpr-tasks/manage/gdpr_sar',
          'bundle argument' => 4,
          'access arguments' => array('administer task entities'),
        ),
      ),
    ),
    'fieldable' => TRUE,
  );

  $entities['gdpr_task_type'] = array(
    'label' => t('Task type'),
    'plural label' => t('Task types'),
    'description' => t('Task types for GDPR Tasks.'),
    'entity class' => 'GDPRTaskType',
    'controller class' => 'EntityAPIControllerExportable',
    'base table' => 'gdpr_task_type',
    'fieldable' => FALSE,
    'bundle of' => 'gdpr_task',
    'exportable' => TRUE,
    'entity keys' => array(
      'id' => 'id',
      'name' => 'type',
      'label' => 'label',
    ),
    'access callback' => 'gdpr_task_type_access',
    'module' => 'gdpr_tasks',
    'admin ui' => array(
      'path' => 'admin/structure/gdpr-tasks',
      'file' => 'gdpr_tasks.admin.inc',
      'controller class' => 'EntityDefaultUIController',
    ),
  );

  return $entities;
}

/**
 * Implements hook_theme().
 */
function gdpr_tasks_theme() {
  return array(
    'gdpr_task' => array(
      'render element' => 'elements',
      'template' => 'templates/gdpr_task',
    ),
  );
}

/**
 * Implements hook_menu().
 */
function gdpr_tasks_menu() {
  $items['user/%user/gdpr/list'] = array(
    'title' => 'Summary',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => -10,
  );
  $items['user/%user/gdpr/requests'] = array(
    'title' => 'My data requests',
    'access arguments' => array('view own gdpr tasks'),
    'page callback' => 'gdpr_task_user_request',
    'page arguments' => array(1),
    'type' => MENU_LOCAL_TASK,
    'file' => 'gdpr_tasks.pages.inc',
  );

  $items['user/%user/gdpr/requests/gdpr_remove/add'] = array(
    'title' => 'Request data removal',
    'page callback' => 'gdpr_tasks_request',
    'page arguments' => array(1, 4),
    'access arguments' => array('request gdpr tasks'),
    'type' => MENU_LOCAL_ACTION,
    'file' => 'gdpr_tasks.pages.inc',
  );
  $items['user/%user/gdpr/requests/gdpr_sar/add'] = array(
    'title' => 'Request data export',
    'page callback' => 'gdpr_tasks_request',
    'page arguments' => array(1, 4),
    'access arguments' => array('request gdpr tasks'),
    'type' => MENU_LOCAL_ACTION,
    'file' => 'gdpr_tasks.pages.inc',
  );
  return $items;
}

/**
 * Implements hook_permission().
 */
function gdpr_tasks_permission() {
  $perms = array(
    'administer task entities' => array(
      'title' => t('Administer task entities'),
      'restrict access' => TRUE,
    ),
    'administer task type entities' => array(
      'title' => t('Administer task entities'),
      'restrict access' => TRUE,
    ),
    'view gdpr tasks' => array(
      'title' => t('View gdpr tasks'),
      'description' => t(''),
    ),
    'view own gdpr tasks' => array(
      'title' => t('View you own gdpr tasks'),
      'description' => t(''),
    ),
    'edit gdpr tasks' => array(
      'title' => t('Edit gdpr tasks'),
      'description' => t(''),
    ),
    'request gdpr tasks' => array(
      'title' => t('Edit gdpr tasks'),
      'description' => t(''),
    ),
  );

  return $perms;
}

/**
 * Implements hook_default_gdpr_task_type().
 */
function gdpr_tasks_default_gdpr_task_type() {
  $types['gdpr_sar'] = new GDPRTaskType(array(
    'type' => 'gdpr_sar',
    'label' => t('SARs Request'),
    'weight' => 0,
    'locked' => TRUE,
  ));
  $types['gdpr_remove'] = new GDPRTaskType(array(
    'type' => 'gdpr_remove',
    'label' => t('Removal Request'),
    'weight' => 0,
    'locked' => TRUE,
  ));
  return $types;
}

/**
 * Access callback for task entities.
 */
function gdpr_task_access($op, $task = NULL, $account = NULL) {
  // @todo Support other operations.
  if (user_access('administer task entities', $account)) {
    return TRUE;
  }
}

/**
 * Access callback for task type entities.
 */
function gdpr_task_type_access($op, $task_type = NULL, $account = NULL) {
  if (user_access('administer task type entities', $account)) {
    return TRUE;
  }
}

/**
 * Load a GDPR Task entity.
 *
 * @param $id
 *   The id of the task.
 *
 * @return GDPRTask|null
 *   The fully loaded task entity if available.
 */
function gdpr_task_load($id) {
  return entity_load_single('gdpr_task', $id);
}

/**
 * Load tasks from the database.
 *
 * @param $ids
 *   An array of task IDs.
 * @param $conditions
 *   (deprecated) An associative array of conditions on the {gdpr_task}
 *   table, where the keys are the database fields and the values are the
 *   values those fields must have. Instead, it is preferable to use
 *   EntityFieldQuery to retrieve a list of entity IDs loadable by
 *   this function.
 * @param $reset
 *   Whether to reset the internal static entity cache.
 *
 * @return
 *   An array of task objects, indexed by task ID.
 *
 * @see entity_load()
 * @see EntityFieldQuery
 */
function gdpr_task_load_multiple($ids = FALSE, $conditions = array(), $reset = FALSE) {
  return entity_load('gdpr_task', $ids, $conditions, $reset);
}


function gdpr_tasks_get_user_tasks($user, $gdpr_task_type = NULL) {
  $query = db_select('gdpr_task', 't')
    ->fields('t', array('id'))
    ->condition('user_id', $user->uid);

  if ($gdpr_task_type) {
    $query->condition('type', $gdpr_task_type);
  }

  $result = $query->execute()
    ->fetchAssoc();

  if (!empty($result)) {
    return gdpr_task_load_multiple($result);
  }

  return $result;
}